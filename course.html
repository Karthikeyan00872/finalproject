<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Tutor - Courses</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Additional styles for tutor upload form */
        .upload-form {
            background: white;
            padding: 1.5rem;
            border-radius: 10px;
            margin-bottom: 2rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        }

        .form-row {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .form-row .form-group {
            flex: 1;
        }

        .chapter-section {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            background: #f9f9f9;
        }

        .video-input {
            display: flex;
            gap: 1rem;
            margin-bottom: 0.5rem;
            align-items: center;
        }

        .video-input input,
        .video-input select {
            flex: 1;
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .remove-btn {
            background: #ff4757;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 0.5rem;
            cursor: pointer;
            width: 30px;
            height: 30px;
        }

        .add-btn {
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 0.5rem 1rem;
            cursor: pointer;
            margin-top: 0.5rem;
        }

        .tutor-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .my-uploads {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .upload-item {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 1rem;
            position: relative;
            min-width: 200px;
        }

        .delete-upload {
            position: absolute;
            top: 5px;
            right: 5px;
            background: #ff4757;
            color: white;
            border: none;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            cursor: pointer;
            font-size: 12px;
        }

        .rating-stars {
            color: #ffd700;
            margin: 0.5rem 0;
        }

        .chapter-list {
            margin-top: 1rem;
        }

        .chapter-item {
            background: #f5f5f5;
            border-radius: 5px;
            padding: 0.5rem;
            margin-bottom: 0.5rem;
            border-left: 3px solid #4CAF50;
        }

        .video-list {
            margin-left: 1rem;
            font-size: 0.9rem;
            color: #666;
        }

        /* Star rating dialog styles */
        .star-rating-dialog {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .star-rating-content {
            background: white;
            padding: 2rem;
            border-radius: 10px;
            text-align: center;
            min-width: 300px;
        }

        .star-container {
            font-size: 2rem;
            color: #ddd;
            margin: 1rem 0;
            cursor: pointer;
        }

        .star {
            cursor: pointer;
            transition: color 0.2s;
        }

        .star:hover,
        .star:hover~.star {
            color: #ffd700 !important;
        }

        /* Video modal styles */
        .video-modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            justify-content: center;
            align-items: center;
        }

        .video-modal-content {
            background-color: #fff;
            padding: 0;
            border-radius: 10px;
            max-width: 90%;
            max-height: 90%;
            overflow: hidden;
            position: relative;
            width: 800px;
            height: 450px;
        }

        .video-close-btn {
            position: absolute;
            right: 10px;
            top: 10px;
            font-size: 28px;
            font-weight: bold;
            color: white;
            cursor: pointer;
            z-index: 2001;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .video-close-btn:hover {
            background: rgba(255, 71, 87, 0.8);
        }

        #videoPlayerContainer {
            width: 100%;
            height: 100%;
            background-color: #000;
        }

        .play-video-btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.8rem;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            margin-right: 10px;
        }

        .play-video-btn:hover {
            background: #45a049;
        }
    </style>
</head>

<body>
    <header>
        <nav>
            <div class="logo">AI Tutor</div>
            <ul class="menu">
                <li><a href="index.html">Home</a></li>
                <li><a href="course.html" class="active">Course</a></li>
                <li><a href="questiontag.html">Question Bank</a></li>
                <li class="dropdown" id="login-dropdown-li">
                    <a href="#" id="login-status-link">Login</a>
                    <div class="dropdown-content" id="auth-dropdown-content">
                        <a href="#" onclick="showLogin('student')">Student Login</a>
                        <a href="#" onclick="showLogin('tutor')">Tutor Login</a>
                        <a href="#" onclick="showLogin('admin')">Admin Login</a>
                        <a href="#" onclick="showRegistration()">Register</a>
                    </div>
                </li>
            </ul>
        </nav>
    </header>

    <main class="main-content">
        <section id="course">
            <div class="hero">
                <h1>Courses</h1>
                <p>Explore courses uploaded by our expert tutors.</p>
            </div>

            <!-- Tutor Upload Form (Visible only when tutor is logged in) -->
            <div id="tutorUploadForm" class="upload-form" style="display: none;">
                <div class="tutor-controls">
                    <h2><i class="fas fa-upload"></i> Upload New Course</h2>
                    <button class="cta-button" onclick="toggleUploadForm()">
                        <i class="fas fa-times"></i> Close
                    </button>
                </div>

                <form id="courseUploadForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="courseTitle">Course Title*</label>
                            <input type="text" id="courseTitle" required placeholder="e.g., Advanced Physics">
                        </div>
                        <div class="form-group">
                            <label for="courseSubject">Subject*</label>
                            <select id="courseSubject" required>
                                <option value="">Select Subject</option>
                                <option value="physics">Physics</option>
                                <option value="chemistry">Chemistry</option>
                                <option value="math">Mathematics</option>
                                <option value="biology">Biology</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="courseGrade">Grade*</label>
                            <select id="courseGrade" required>
                                <option value="">Select Grade</option>
                                <option value="10th">10th Grade</option>
                                <option value="12th">12th Grade</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="courseDescription">Description</label>
                        <textarea id="courseDescription" rows="3" placeholder="Describe your course..."></textarea>
                    </div>

                    <div id="chaptersContainer">
                        <h3>Chapters & Videos</h3>
                        <div class="chapter-section" data-chapter="1">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Chapter 1 Title*</label>
                                    <input type="text" class="chapter-title" required placeholder="e.g., Newton's Laws">
                                </div>
                                <button type="button" class="remove-btn" onclick="removeChapter(1)">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>

                            <div class="video-section">
                                <label>Video Links</label>
                                <div class="video-input">
                                    <select class="video-type" onchange="changeVideoType(this)">
                                        <option value="link">Video Link</option>
                                        <option value="upload">Upload Video</option>
                                    </select>
                                    <input type="text" class="video-url" placeholder="Video URL (YouTube/Vimeo/etc)">
                                    <input type="file" class="video-file" accept="video/*" style="display: none;">
                                    <button type="button" class="remove-btn" onclick="removeVideo(this)">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                                <button type="button" class="add-btn" onclick="addVideo(this)">
                                    <i class="fas fa-plus"></i> Add Another Video
                                </button>
                            </div>
                        </div>
                    </div>

                    <button type="button" class="cta-button" onclick="addChapter()">
                        <i class="fas fa-plus"></i> Add Another Chapter
                    </button>

                    <div style="margin-top: 2rem;">
                        <button type="submit" class="cta-button login-btn">
                            <i class="fas fa-upload"></i> Upload Course
                        </button>
                    </div>
                </form>
            </div>

            <!-- My Uploads Section (for tutors) -->
            <div id="myUploads" class="my-uploads" style="display: none;">
                <h2><i class="fas fa-list"></i> My Uploaded Courses</h2>
                <!-- Dynamic content will be loaded here -->
            </div>

            <!-- Course Filter -->
            <div class="search-filter">
                <select id="gradeFilter">
                    <option value="all">All Grades</option>
                    <option value="10th">10th Grade</option>
                    <option value="12th">12th Grade</option>
                </select>
                <select id="subjectFilter">
                    <option value="all">All Subjects</option>
                    <option value="physics">Physics</option>
                    <option value="chemistry">Chemistry</option>
                    <option value="math">Mathematics</option>
                    <option value="biology">Biology</option>
                </select>
                <button class="cta-button" onclick="loadCourses()">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
            </div>

            <!-- Tutor Upload Button -->
            <div id="tutorUploadBtn" style="margin-bottom: 2rem; display: none;">
                <button class="cta-button" onclick="toggleUploadForm()">
                    <i class="fas fa-plus-circle"></i> Upload New Course
                </button>
            </div>

            <!-- Courses Container (Dynamic Content) -->
            <div id="coursesContainer" class="courses-container">
                <p class="loading">Loading courses...</p>
            </div>

            <!-- Stats Section -->
            <div class="stats">
                <div class="stat-item">
                    <h3 id="totalCourses">0</h3>
                    <p>Courses Available</p>
                </div>
                <div class="stat-item">
                    <h3 id="totalTutors">0</h3>
                    <p>Expert Tutors</p>
                </div>
                <div class="stat-item">
                    <h3 id="totalVideos">0</h3>
                    <p>Video Lessons</p>
                </div>
            </div>
        </section>

        <!-- Video Modal -->
        <div id="videoModal" class="video-modal">
            <div class="video-modal-content">
                <span class="video-close-btn" onclick="closeVideoModal()">&times;</span>
                <div id="videoPlayerContainer"></div>
            </div>
        </div>

        <!-- Login Modal -->
        <div id="loginModal" class="modal">
            <div class="modal-content">
                <div id="login-form-container"></div>
            </div>
        </div>
    </main>

    <footer>
        <div class="footer-content">
            <p>&copy; 2024 AI Tutor. All rights reserved.</p>
            <div class="footer-links">
                <a href="privacy.html">Privacy Policy</a>
                <a href="terms.html">Terms of Service</a>
                <a href="contact.html">Contact Us</a>
            </div>
        </div>
    </footer>

    <script src="common.js"></script>
    <script src="course.js"></script>
    <script>
        // Update the submitRating function in course.html
        async function submitRating(rating, courseId, chapterIndex) {
            console.log("Submitting rating from course.html:", {
                rating,
                courseId,
                chapterIndex,
                username: window.currentUsername
            });

            if (rating < 1 || rating > 5) {
                alert("Please select a rating between 1 and 5 stars");
                return;
            }

            if (!window.currentUsername) {
                alert("Please log in to rate courses");
                showLogin('student');
                return;
            }

            try {
                const response = await fetch(window.BACKEND_URL + '/courses/rate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        username: window.currentUsername,
                        course_id: courseId,
                        chapter: chapterIndex,
                        rating: rating
                    })
                });

                console.log("Rating response status:", response.status);
                const result = await response.json();
                console.log("Rating response data:", result);

                // Remove rating dialog
                const dialog = document.querySelector('.star-rating-dialog');
                if (dialog) dialog.remove();

                if (result.success) {
                    alert("Thank you for your rating!");
                    // Refresh to show updated ratings
                    if (window.loadCourses) {
                        window.loadCourses();
                    }
                } else {
                    alert("Error: " + (result.message || 'Failed to submit rating'));
                }
            } catch (error) {
                console.error("Rating error:", error);
                alert("Failed to submit rating: " + error.message);

                // Remove rating dialog on error too
                const dialog = document.querySelector('.star-rating-dialog');
                if (dialog) dialog.remove();
            }
        }
        
        // JavaScript for course management
        let chapterCounter = 1;

        function toggleUploadForm() {
            const form = document.getElementById('tutorUploadForm');
            if (form) {
                form.style.display = form.style.display === 'none' ? 'block' : 'none';
            }
        }

        function addChapter() {
            chapterCounter++;
            const chaptersContainer = document.getElementById('chaptersContainer');

            const chapterDiv = document.createElement('div');
            chapterDiv.className = 'chapter-section';
            chapterDiv.setAttribute('data-chapter', chapterCounter);
            chapterDiv.innerHTML = `
                <div class="form-row">
                    <div class="form-group">
                        <label>Chapter ${chapterCounter} Title*</label>
                        <input type="text" class="chapter-title" required placeholder="e.g., Newton's Laws">
                    </div>
                    <button type="button" class="remove-btn" onclick="removeChapter(${chapterCounter})">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div class="video-section">
                    <label>Video Links</label>
                    <div class="video-input">
                        <select class="video-type" onchange="changeVideoType(this)">
                            <option value="link">Video Link</option>
                            <option value="upload">Upload Video</option>
                        </select>
                        <input type="text" class="video-url" placeholder="Video URL (YouTube/Vimeo/etc)">
                        <input type="file" class="video-file" accept="video/*" style="display: none;">
                        <button type="button" class="remove-btn" onclick="removeVideo(this)">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <button type="button" class="add-btn" onclick="addVideo(this)">
                        <i class="fas fa-plus"></i> Add Another Video
                    </button>
                </div>
            `;

            chaptersContainer.appendChild(chapterDiv);
        }

        function removeChapter(chapterNum) {
            if (chapterCounter > 1) {
                const chapter = document.querySelector(`[data-chapter="${chapterNum}"]`);
                if (chapter) {
                    chapter.remove();
                    // Re-number remaining chapters
                    const chapters = document.querySelectorAll('.chapter-section');
                    chapters.forEach((chap, index) => {
                        chap.setAttribute('data-chapter', index + 1);
                        const label = chap.querySelector('label');
                        if (label) {
                            label.textContent = `Chapter ${index + 1} Title*`;
                        }
                    });
                    chapterCounter = chapters.length;
                }
            }
        }

        function addVideo(button) {
            const videoSection = button.parentElement;
            const videoDiv = document.createElement('div');
            videoDiv.className = 'video-input';
            videoDiv.innerHTML = `
                <select class="video-type" onchange="changeVideoType(this)">
                    <option value="link">Video Link</option>
                    <option value="upload">Upload Video</option>
                </select>
                <input type="text" class="video-url" placeholder="Video URL (YouTube/Vimeo/etc)">
                <input type="file" class="video-file" accept="video/*" style="display: none;">
                <button type="button" class="remove-btn" onclick="removeVideo(this)">
                    <i class="fas fa-times"></i>
                </button>
            `;
            videoSection.insertBefore(videoDiv, button);
        }

        function removeVideo(button) {
            const videoDiv = button.parentElement;
            if (videoDiv.parentElement.querySelectorAll('.video-input').length > 1) {
                videoDiv.remove();
            }
        }

        function changeVideoType(selectElement) {
            const videoInputDiv = selectElement.parentElement;
            const urlInput = videoInputDiv.querySelector('.video-url');
            const fileInput = videoInputDiv.querySelector('.video-file');

            if (selectElement.value === 'link') {
                urlInput.style.display = 'block';
                fileInput.style.display = 'none';
                fileInput.value = ''; // Clear file input
            } else {
                urlInput.style.display = 'none';
                fileInput.style.display = 'block';
                urlInput.value = ''; // Clear URL input
            }
        }

        // Helper function to convert file to base64
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }

        async function uploadCourse(event) {
            event.preventDefault();

            if (!window.currentUsername) {
                alert("Please log in as tutor to upload courses");
                return;
            }

            // Collect form data
            const title = document.getElementById('courseTitle').value;
            const subject = document.getElementById('courseSubject').value;
            const grade = document.getElementById('courseGrade').value;
            const description = document.getElementById('courseDescription').value;

            // Collect chapters and videos
            const chapters = [];
            const chapterSections = document.querySelectorAll('.chapter-section');

            for (const section of chapterSections) {
                const chapterTitle = section.querySelector('.chapter-title').value;
                const videoInputs = section.querySelectorAll('.video-input');
                const videoUrls = [];

                for (const videoInput of videoInputs) {
                    const videoType = videoInput.querySelector('.video-type').value;

                    if (videoType === 'link') {
                        const url = videoInput.querySelector('.video-url').value;
                        if (url.trim() !== '') {
                            videoUrls.push(url);
                        }
                    } else {
                        const fileInput = videoInput.querySelector('.video-file');
                        if (fileInput.files.length > 0) {
                            const file = fileInput.files[0];
                            // Check file size (limit to 50MB for demo)
                            if (file.size > 50 * 1024 * 1024) {
                                alert(`File ${file.name} is too large. Maximum size is 50MB.`);
                                return;
                            }
                            // Convert file to base64 for storage
                            const base64 = await fileToBase64(file);
                            videoUrls.push(base64);
                        }
                    }
                }

                if (chapterTitle && videoUrls.length > 0) {
                    chapters.push({
                        title: chapterTitle,
                        videos: videoUrls
                    });
                }
            }

            if (!title || !subject || !grade || chapters.length === 0) {
                alert("Please fill all required fields and add at least one chapter with videos");
                return;
            }

            const courseData = {
                username: window.currentUsername,
                title: title,
                subject: subject,
                grade: grade,
                description: description,
                chapters: chapters
            };

            try {
                const response = await fetch(window.BACKEND_URL + '/tutor/courses', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(courseData)
                });

                const result = await response.json();

                if (result.success) {
                    alert("Course uploaded successfully!");
                    // Reset form
                    document.getElementById('courseUploadForm').reset();
                    // Remove extra chapters
                    while (chapterCounter > 1) {
                        removeChapter(chapterCounter);
                    }
                    toggleUploadForm();
                    // Reload courses
                    if (window.loadCourses) {
                        window.loadCourses();
                    }
                    if (window.loadMyUploads) {
                        window.loadMyUploads();
                    }
                } else {
                    alert("Error: " + result.message);
                }
            } catch (error) {
                console.error("Upload error:", error);
                alert("Failed to upload course. Please try again.");
            }
        }

        // ==================== FIXED VIDEO PLAYER FUNCTIONS ====================
        
        // Improved YouTube URL detection and extraction
        function isYouTubeUrl(url) {
            if (!url) return false;
            const cleanUrl = url.trim().toLowerCase();
            return cleanUrl.includes('youtube.com') || 
                   cleanUrl.includes('youtu.be') || 
                   cleanUrl.includes('youtube-nocookie.com');
        }

        function getYouTubeId(url) {
            if (!url) return null;
            
            let videoId = null;
            const cleanUrl = url.trim();
            
            // Try different patterns
            // Pattern 1: youtu.be/VIDEO_ID
            if (cleanUrl.includes('youtu.be/')) {
                videoId = cleanUrl.split('youtu.be/')[1];
                if (videoId.includes('?')) {
                    videoId = videoId.split('?')[0];
                }
            }
            // Pattern 2: youtube.com/watch?v=VIDEO_ID
            else if (cleanUrl.includes('youtube.com/watch?v=')) {
                videoId = cleanUrl.split('v=')[1];
                const ampersandPosition = videoId.indexOf('&');
                if (ampersandPosition !== -1) {
                    videoId = videoId.substring(0, ampersandPosition);
                }
            }
            // Pattern 3: youtube.com/embed/VIDEO_ID
            else if (cleanUrl.includes('youtube.com/embed/')) {
                videoId = cleanUrl.split('embed/')[1];
                if (videoId.includes('?')) {
                    videoId = videoId.split('?')[0];
                }
            }
            // Pattern 4: youtube.com/v/VIDEO_ID
            else if (cleanUrl.includes('youtube.com/v/')) {
                videoId = cleanUrl.split('v/')[1];
                if (videoId.includes('?')) {
                    videoId = videoId.split('?')[0];
                }
            }
            
            // Validate video ID format (should be 11 characters)
            if (videoId && /^[a-zA-Z0-9_-]{11}$/.test(videoId)) {
                return videoId;
            }
            
            return null;
        }

        function isVimeoUrl(url) {
            if (!url) return false;
            return url.trim().toLowerCase().includes('vimeo.com');
        }

        function getVimeoId(url) {
            if (!url) return null;
            
            const cleanUrl = url.trim();
            const patterns = [
                /vimeo\.com\/(\d+)/,
                /vimeo\.com\/video\/(\d+)/,
                /vimeo\.com\/channels\/[^/]+\/(\d+)/,
                /vimeo\.com\/groups\/[^/]+\/videos\/(\d+)/
            ];
            
            for (const pattern of patterns) {
                const match = cleanUrl.match(pattern);
                if (match && match[1]) {
                    return match[1];
                }
            }
            
            return null;
        }

        // Improved video modal function
        function openVideoModal(videoUrl) {
            const videoModal = document.getElementById('videoModal');
            const videoPlayerContainer = document.getElementById('videoPlayerContainer');

            if (!videoModal || !videoPlayerContainer) {
                console.error("Video modal elements not found");
                return;
            }

            // Clear previous content
            videoPlayerContainer.innerHTML = '';
            
            // Clean the URL
            let cleanUrl = videoUrl ? videoUrl.trim() : '';
            
            if (!cleanUrl) {
                videoPlayerContainer.innerHTML = '<div style="color: white; padding: 20px; text-align: center;">No video URL provided</div>';
                videoModal.style.display = 'flex';
                return;
            }
            
            console.log("Playing video:", cleanUrl);

            // Check video type and create appropriate player
            if (isYouTubeUrl(cleanUrl)) {
                const videoId = getYouTubeId(cleanUrl);
                if (!videoId) {
                    videoPlayerContainer.innerHTML = '<div style="color: white; padding: 20px; text-align: center;">Invalid YouTube URL format</div>';
                    videoModal.style.display = 'flex';
                    return;
                }
                
                // Create YouTube iframe with proper attributes
                const iframe = document.createElement('iframe');
                iframe.width = '100%';
                iframe.height = '100%';
                iframe.src = `https://www.youtube.com/embed/${videoId}?rel=0&modestbranding=1&autoplay=1`;
                iframe.frameBorder = '0';
                iframe.allow = 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share';
                iframe.allowFullscreen = true;
                iframe.title = 'YouTube video player';
                iframe.setAttribute('loading', 'lazy');
                
                videoPlayerContainer.appendChild(iframe);
                console.log("YouTube iframe created with video ID:", videoId);
                
            } else if (isVimeoUrl(cleanUrl)) {
                const videoId = getVimeoId(cleanUrl);
                if (!videoId) {
                    videoPlayerContainer.innerHTML = '<div style="color: white; padding: 20px; text-align: center;">Invalid Vimeo URL format</div>';
                    videoModal.style.display = 'flex';
                    return;
                }
                
                const iframe = document.createElement('iframe');
                iframe.src = `https://player.vimeo.com/video/${videoId}?autoplay=1`;
                iframe.width = '100%';
                iframe.height = '100%';
                iframe.frameBorder = '0';
                iframe.allow = 'autoplay; fullscreen; picture-in-picture';
                iframe.allowFullscreen = true;
                iframe.title = 'Vimeo video player';
                
                videoPlayerContainer.appendChild(iframe);
                console.log("Vimeo iframe created with video ID:", videoId);
                
            } else if (cleanUrl.startsWith('data:video/') || cleanUrl.startsWith('blob:')) {
                // For base64 encoded videos
                const video = document.createElement('video');
                video.controls = true;
                video.autoplay = true;
                video.style.width = '100%';
                video.style.height = '100%';
                video.style.backgroundColor = '#000';

                const source = document.createElement('source');
                source.src = cleanUrl;

                // Detect video type from data URL
                if (cleanUrl.startsWith('data:video/mp4')) {
                    source.type = 'video/mp4';
                } else if (cleanUrl.startsWith('data:video/webm')) {
                    source.type = 'video/webm';
                } else if (cleanUrl.startsWith('data:video/ogg')) {
                    source.type = 'video/ogg';
                } else {
                    source.type = 'video/mp4';
                }

                video.appendChild(source);
                video.appendChild(document.createTextNode('Your browser does not support the video tag.'));
                videoPlayerContainer.appendChild(video);
                console.log("Base64 video player created");
                
            } else if (cleanUrl.startsWith('http')) {
                // Generic video player for direct video URLs
                const video = document.createElement('video');
                video.controls = true;
                video.autoplay = true;
                video.style.width = '100%';
                video.style.height = '100%';
                video.style.backgroundColor = '#000';

                const source = document.createElement('source');
                source.src = cleanUrl;
                
                // Try to detect video type from URL extension
                const urlLower = cleanUrl.toLowerCase();
                if (urlLower.endsWith('.mp4')) {
                    source.type = 'video/mp4';
                } else if (urlLower.endsWith('.webm')) {
                    source.type = 'video/webm';
                } else if (urlLower.endsWith('.ogg') || urlLower.endsWith('.ogv')) {
                    source.type = 'video/ogg';
                } else if (urlLower.endsWith('.mov')) {
                    source.type = 'video/quicktime';
                } else if (urlLower.endsWith('.avi')) {
                    source.type = 'video/x-msvideo';
                } else {
                    source.type = 'video/mp4';
                }

                video.appendChild(source);
                video.appendChild(document.createTextNode('Your browser does not support the video tag.'));
                videoPlayerContainer.appendChild(video);
                console.log("Direct video player created");
                
            } else {
                // Unknown video format
                videoPlayerContainer.innerHTML = `
                    <div style="color: white; padding: 20px; text-align: center;">
                        <p>Cannot play this video format</p>
                        <p><a href="${cleanUrl}" target="_blank" style="color: #4CAF50;">Open video in new tab</a></p>
                    </div>
                `;
                console.log("Unknown video format:", cleanUrl);
            }

            videoModal.style.display = 'flex';
        }

        function closeVideoModal() {
            const videoModal = document.getElementById('videoModal');
            const videoPlayerContainer = document.getElementById('videoPlayerContainer');

            if (videoModal) {
                videoModal.style.display = 'none';
                if (videoPlayerContainer) {
                    // Stop all videos
                    const videos = videoPlayerContainer.querySelectorAll('video, iframe');
                    videos.forEach(video => {
                        if (video.tagName === 'VIDEO') {
                            video.pause();
                            video.currentTime = 0;
                        } else if (video.tagName === 'IFRAME') {
                            // Stop YouTube/Vimeo videos by removing the src
                            video.src = '';
                        }
                    });
                    // Clear container
                    videoPlayerContainer.innerHTML = '';
                }
            }
        }

        function initCoursePage() {
            console.log('Initializing course page');

            // Add event listener to upload form
            const form = document.getElementById('courseUploadForm');
            if (form) {
                form.addEventListener('submit', uploadCourse);
            }

            // Check tutor login status
            checkTutorLoginStatus();

            // Listen for login state changes
            window.addEventListener('loginStateChange', function (event) {
                console.log('Course page: Login state changed');
                checkTutorLoginStatus();
                if (window.loadCourses) {
                    window.loadCourses();
                }
            });

            // Close video modal when clicking outside
            const videoModal = document.getElementById('videoModal');
            if (videoModal) {
                videoModal.addEventListener('click', function (event) {
                    if (event.target === videoModal) {
                        closeVideoModal();
                    }
                });
            }

            // Close video modal with Escape key
            document.addEventListener('keydown', function (event) {
                if (event.key === 'Escape') {
                    closeVideoModal();
                }
            });
        }

        // Check tutor login status
        function checkTutorLoginStatus() {
            const isTutor = window.currentUsername && window.userType === 'tutor';
            console.log('Checking tutor status:', {
                username: window.currentUsername,
                userType: window.userType,
                isTutor: isTutor
            });

            const uploadBtn = document.getElementById('tutorUploadBtn');
            const myUploads = document.getElementById('myUploads');

            if (isTutor) {
                console.log('Showing tutor controls');
                if (uploadBtn) uploadBtn.style.display = 'block';
                if (myUploads) myUploads.style.display = 'block';
                // Load tutor's courses
                if (window.loadMyUploads) {
                    setTimeout(() => window.loadMyUploads(), 100);
                }
            } else {
                console.log('Hiding tutor controls');
                if (uploadBtn) uploadBtn.style.display = 'none';
                if (myUploads) myUploads.style.display = 'none';

                const uploadForm = document.getElementById('tutorUploadForm');
                if (uploadForm) uploadForm.style.display = 'none';
            }
        }

        // Make functions globally available
        window.toggleUploadForm = toggleUploadForm;
        window.addChapter = addChapter;
        window.removeChapter = removeChapter;
        window.addVideo = addVideo;
        window.removeVideo = removeVideo;
        window.changeVideoType = changeVideoType;
        window.uploadCourse = uploadCourse;
        window.openVideoModal = openVideoModal;
        window.closeVideoModal = closeVideoModal;
        window.isYouTubeUrl = isYouTubeUrl;
        window.getYouTubeId = getYouTubeId;
        window.isVimeoUrl = isVimeoUrl;
        window.getVimeoId = getVimeoId;

        // 页面加载时初始化
        document.addEventListener('DOMContentLoaded', function () {
            // 确保 common.js 已加载
            setTimeout(() => {
                initCoursePage();
            }, 100);
        });
    </script>
</body>

</html>