<!-- [file name]: questiontag.html -->
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Tutor - Question Bank</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Additional styles for question upload form */
        .upload-form {
            background: white;
            padding: 1.5rem;
            border-radius: 10px;
            margin-bottom: 2rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            max-height: 80vh;
            overflow-y: auto;
        }

        .tutor-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .form-row {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .form-row .form-group {
            flex: 1;
        }

        .file-preview {
            margin-top: 1rem;
            padding: 1rem;
            background: #f5f5f5;
            border-radius: 5px;
            border: 1px dashed #ccc;
        }

        .file-preview img {
            max-width: 100px;
            max-height: 100px;
            margin-right: 10px;
        }

        .my-uploads {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin-bottom: 2rem;
            max-height: 60vh;
            overflow-y: auto;
        }

        .upload-item {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 1rem;
            position: relative;
            min-width: 200px;
        }

        .delete-upload {
            position: absolute;
            top: 5px;
            right: 5px;
            background: #ff4757;
            color: white;
            border: none;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            cursor: pointer;
            font-size: 12px;
        }

        .question-content {
            max-height: 150px;
            overflow-y: auto;
            margin: 0.5rem 0;
            padding: 0.5rem;
            background: #f9f9f9;
            border-radius: 5px;
        }

        .has-file {
            color: #3498db;
            font-size: 0.8rem;
            margin-top: 0.5rem;
        }

        .file-upload-area {
            border: 2px dashed #3498db;
            border-radius: 10px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            margin: 1rem 0;
            background: #f8fafc;
        }

        .file-upload-area:hover {
            background: #e8f4fd;
        }

        .file-upload-area i {
            font-size: 3rem;
            color: #3498db;
            margin-bottom: 1rem;
        }

        #fileInput {
            display: none;
        }

        /* Approval message styles */
        .approval-message {
            background: white;
            border-radius: 10px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            text-align: center;
            border-left: 5px solid #f39c12;
        }

        .approval-message i {
            font-size: 3rem;
            color: #f39c12;
            margin-bottom: 1rem;
        }

        .approval-message h3 {
            color: #333;
            margin-bottom: 1rem;
        }

        .approval-message p {
            color: #666;
            margin-bottom: 0.5rem;
            line-height: 1.6;
        }

        .status {
            display: inline-block;
            padding: 0.3rem 1rem;
            border-radius: 20px;
            font-weight: 600;
            margin-top: 1rem;
        }

        .status.pending {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .status.rejected {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status.approved {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .pending-approval,
        .rejected-approval {
            width: 100%;
        }

        /* Scroll container for main content */
        .scroll-container {
            max-height: 80vh;
            overflow-y: auto;
            padding-right: 10px;
        }

        .scroll-container::-webkit-scrollbar {
            width: 8px;
        }

        .scroll-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        .scroll-container::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }

        .scroll-container::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
</head>

<body>
    <header>
        <nav>
            <div class="logo">AI Tutor</div>
            <ul class="menu">
                <li><a href="index.html">Home</a></li>
                <li><a href="course.html">Course</a></li>
                <li><a href="questiontag.html" class="active">Question Bank</a></li>
                <li class="dropdown" id="login-dropdown-li">
                    <a href="#" id="login-status-link">Login</a>
                    <div class="dropdown-content" id="auth-dropdown-content">
                        <a href="#" onclick="showLogin('student')">Student Login</a>
                        <a href="#" onclick="showLogin('tutor')">Tutor Login</a>
                        <a href="#" onclick="showLogin('admin')">Admin Login</a>
                        <a href="#" onclick="showRegistration()">Register</a>
                    </div>
                </li>
            </ul>
        </nav>
    </header>

    <main class="main-content">
        <section id="questiontag">
            <div class="hero">
                <h1>Question Bank</h1>
                <p>Download individual questions or entire sets for practice. Questions are available in .txt format.
                </p>
            </div>

            <!-- Tutor Approval Message -->
            <div id="tutorApprovalMessage" class="approval-message" style="display: none;">
                <!-- Content will be populated by JavaScript -->
            </div>

            <!-- Tutor Upload Form (Visible only when tutor is logged in and approved) -->
            <div id="tutorUploadForm" class="upload-form" style="display: none;">
                <div class="tutor-controls">
                    <h2><i class="fas fa-upload"></i> Upload New Question</h2>
                    <button class="cta-button" onclick="toggleQuestionUploadForm()">
                        <i class="fas fa-times"></i> Close
                    </button>
                </div>

                <form id="questionUploadForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="questionTitle">Question Title*</label>
                            <input type="text" id="questionTitle" required placeholder="e.g., Newton's Laws Problem">
                        </div>
                        <div class="form-group">
                            <label for="questionSubject">Subject*</label>
                            <select id="questionSubject" required>
                                <option value="">Select Subject</option>
                                <option value="physics">Physics</option>
                                <option value="chemistry">Chemistry</option>
                                <option value="math">Mathematics</option>
                                <option value="biology">Biology</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="questionGrade">Grade*</label>
                            <select id="questionGrade" required>
                                <option value="">Select Grade</option>
                                <option value="10th">10th Grade</option>
                                <option value="12th">12th Grade</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="questionDifficulty">Difficulty*</label>
                            <select id="questionDifficulty" required>
                                <option value="">Select Difficulty</option>
                                <option value="easy">Easy</option>
                                <option value="medium">Medium</option>
                                <option value="hard">Hard</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="questionChapter">Chapter</label>
                            <input type="text" id="questionChapter" placeholder="e.g., Chapter 5">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="questionText">Question Text*</label>
                        <textarea id="questionText" rows="4" required
                            placeholder="Enter the question text here..."></textarea>
                    </div>

                    <!-- File Upload Area -->
                    <div class="file-upload-area" onclick="document.getElementById('fileInput').click()">
                        <i class="fas fa-cloud-upload-alt"></i>
                        <h3>Upload PDF/Image (Optional)</h3>
                        <p>Click to browse or drag and drop</p>
                        <p id="fileName" style="color: #666; margin-top: 10px;"></p>
                        <input type="file" id="fileInput" accept=".pdf,.jpg,.jpeg,.png,.txt"
                            onchange="handleFileSelect(event)">
                    </div>

                    <div id="filePreview" class="file-preview" style="display: none;">
                        <strong>Selected File:</strong> <span id="previewFileName"></span>
                        <span id="fileSize" style="color: #666; margin-left: 10px;"></span>
                        <button type="button" class="remove-btn" onclick="removeFile()" style="margin-left: 10px;">
                            <i class="fas fa-times"></i> Remove
                        </button>
                    </div>

                    <div style="margin-top: 2rem;">
                        <button type="submit" class="cta-button login-btn">
                            <i class="fas fa-upload"></i> Upload Question
                        </button>
                    </div>
                </form>
            </div>

            <!-- My Uploads Section (for tutors) -->
            <div id="myQuestionUploads" class="my-uploads" style="display: none;">
                <h2><i class="fas fa-list"></i> My Uploaded Questions</h2>
                <!-- Dynamic content will be loaded here -->
            </div>

            <!-- Tutor Upload Button -->
            <div id="tutorQuestionUploadBtn" style="margin-bottom: 2rem; display: none;">
                <button class="cta-button" onclick="toggleQuestionUploadForm()">
                    <i class="fas fa-plus-circle"></i> Upload New Question
                </button>
            </div>

            <!-- Search and Filter -->
            <div class="search-filter">
                <input type="text" id="questionSearch" placeholder="Search questions...">
                <select id="gradeSelect">
                    <option value="all">All Grades</option>
                    <option value="10th">10th Grade</option>
                    <option value="12th">12th Grade</option>
                </select>
                <select id="subjectSelect">
                    <option value="all">All Subjects</option>
                    <option value="physics">Physics</option>
                    <option value="chemistry">Chemistry</option>
                    <option value="math">Mathematics</option>
                    <option value="biology">Biology</option>
                </select>
            </div>

            <!-- Questions Container (Dynamic Content) -->
            <div id="questionsContainer" class="questions-grid">
                <!-- Dynamic questions will be loaded here -->
                <p class="loading">Loading questions...</p>
            </div>

            <!-- Stats Section -->
            <div class="question-stats">
                <p><i class="fas fa-info-circle"></i> Total Questions: <span id="totalQuestions">0</span> | Last
                    Updated: Today</p>
            </div>
        </section>

        <!-- Login Modal -->
        <div id="loginModal" class="modal">
            <div class="modal-content">
                <div id="login-form-container"></div>
            </div>
        </div>
    </main>

    <footer>
        <div class="footer-content">
            <p>&copy; 2024 AI Tutor. All rights reserved.</p>
            <div class="footer-links">
                <a href="privacy.html">Privacy Policy</a>
                <a href="terms.html">Terms of Service</a>
                <a href="contact.html">Contact Us</a>
            </div>
        </div>
    </footer>

    <script src="common.js"></script>
    <script src="questiontag.js"></script>
    <script>
        // New JavaScript for question management
        let selectedFile = null;

        function toggleQuestionUploadForm() {
            const form = document.getElementById('tutorUploadForm');
            form.style.display = form.style.display === 'none' ? 'block' : 'none';
            if (form.style.display === 'block') {
                window.scrollTo({ top: form.offsetTop - 100, behavior: 'smooth' });
            }
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                selectedFile = file;
                document.getElementById('fileName').textContent = file.name;
                document.getElementById('previewFileName').textContent = file.name;
                document.getElementById('fileSize').textContent = `(${(file.size / 1024).toFixed(2)} KB)`;
                document.getElementById('filePreview').style.display = 'block';
            }
        }

        function removeFile() {
            selectedFile = null;
            document.getElementById('fileInput').value = '';
            document.getElementById('fileName').textContent = '';
            document.getElementById('filePreview').style.display = 'none';
        }

        async function uploadQuestion(event) {
            event.preventDefault();

            if (!window.currentUsername) {
                showNotification("Please log in as tutor to upload questions", "error");
                return;
            }

            // Check if tutor is approved
            if (window.tutorApprovalStatus !== 'approved') {
                showNotification("Only approved tutors can upload questions. Please wait for admin approval.", "warning");
                return;
            }

            // Collect form data
            const title = document.getElementById('questionTitle').value;
            const subject = document.getElementById('questionSubject').value;
            const grade = document.getElementById('questionGrade').value;
            const difficulty = document.getElementById('questionDifficulty').value;
            const chapter = document.getElementById('questionChapter').value;
            const questionText = document.getElementById('questionText').value;

            if (!title || !subject || !grade || !difficulty || !questionText) {
                showNotification("Please fill all required fields", "warning");
                return;
            }

            const questionData = {
                username: window.currentUsername,
                question: questionText,
                subject: subject,
                grade: grade,
                difficulty: difficulty,
                chapter: chapter || '',
                title: title
            };

            // Handle file upload
            if (selectedFile) {
                const reader = new FileReader();
                reader.onload = async function (e) {
                    questionData.file_data = e.target.result.split(',')[1]; // Base64 data
                    questionData.file_name = selectedFile.name;
                    questionData.file_type = selectedFile.type;

                    await sendQuestionToServer(questionData);
                };
                reader.readAsDataURL(selectedFile);
            } else {
                // If editing and no new file selected, we just send metadata. 
                // However, backend might wipe file if we don't handle it.
                // api_server.py update_question checks if 'file_data' is present to update.
                // So if we don't send it, it keeps existing.
                // But we must NOT send empty file_data if we want to keep existing.
                await sendQuestionToServer(questionData);
            }
        }

        async function sendQuestionToServer(questionData) {
            try {
                let url = window.BACKEND_URL + '/tutor/questions';
                let method = 'POST';
                let successMsg = "Question uploaded successfully!";

                if (window.isEditingQuestion && window.editingQuestionId) {
                    url = window.BACKEND_URL + `/tutor/questions/${window.editingQuestionId}`;
                    method = 'PUT';
                    successMsg = "Question updated successfully!";
                }

                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(questionData)
                });

                const result = await response.json();

                if (result.success) {
                    showNotification(successMsg, "success");
                    resetQuestionForm();
                    // Reload questions
                    loadQuestions();
                    loadMyQuestionUploads();
                } else {
                    showNotification("Error: " + result.message, "error");
                }
            } catch (error) {
                console.error("Upload error:", error);
                showNotification("Failed to upload/update question. Please try again.", "error");
            }
        }

        function resetQuestionForm() {
            document.getElementById('questionUploadForm').reset();
            removeFile();
            // Reset edit state
            window.isEditingQuestion = false;
            window.editingQuestionId = null;
            // Reset button
            const btn = document.querySelector('#questionUploadForm button[type="submit"]');
            btn.innerHTML = '<i class="fas fa-upload"></i> Upload Question';
            // Hide form if it was toggle-based, essentially we just scroll away or keep open?
            // Let's toggle it off to be clean
            toggleQuestionUploadForm();
            // But if it's already hidden, toggle toggles it on. 
            // toggleQuestionUploadForm just flips display.
            // We should force close or check state.
            const form = document.getElementById('tutorUploadForm');
            if (form.style.display === 'block') {
                form.style.display = 'none';
            }
        }

        async function editQuestion(questionId) {
            try {
                // We need to fetch the question details.
                // Since we don't have a direct get-one endpoint exposed easily, we can find it in the loaded questions list usually.
                // But safer to fetch all and find, or assume we have them.
                // Let's look at loadMyQuestionUploads, it fetches '/questions'.
                const response = await fetch(window.BACKEND_URL + '/questions');
                const result = await response.json();

                if (result.success) {
                    const question = result.questions.find(q => q._id === questionId);
                    if (!question) {
                        showNotification("Question not found", "error");
                        return;
                    }

                    // Populate
                    window.isEditingQuestion = true;
                    window.editingQuestionId = questionId;

                    document.getElementById('questionTitle').value = question.title || '';
                    document.getElementById('questionSubject').value = question.subject;
                    document.getElementById('questionGrade').value = question.grade;
                    document.getElementById('questionDifficulty').value = question.difficulty;
                    document.getElementById('questionChapter').value = question.chapter || '';
                    document.getElementById('questionText').value = question.question;

                    // Handle file existing display
                    if (question.has_file) {
                        document.getElementById('fileName').textContent = "Existing file attached (Upload new to replace)";
                        document.getElementById('previewFileName').textContent = "Existing File";
                        document.getElementById('filePreview').style.display = 'block';
                    } else {
                        removeFile();
                    }

                    // Change button
                    const btn = document.querySelector('#questionUploadForm button[type="submit"]');
                    btn.innerHTML = '<i class="fas fa-save"></i> Update Question';

                    // Show form
                    const form = document.getElementById('tutorUploadForm');
                    form.style.display = 'block';
                    window.scrollTo({ top: form.offsetTop - 100, behavior: 'smooth' });
                }
            } catch (e) {
                console.error(e);
                showNotification("Error loading question", "error");
            }
        }

        async function loadMyQuestionUploads() {
            if (!window.currentUsername || window.userType !== 'tutor' || window.tutorApprovalStatus !== 'approved') return;

            try {
                const response = await fetch(window.BACKEND_URL + '/questions');
                const result = await response.json();

                if (result.success) {
                    const myUploadsDiv = document.getElementById('myQuestionUploads');
                    const myQuestions = result.questions.filter(question =>
                        question.tutor_username === window.currentUsername
                    );

                    if (myQuestions.length > 0) {
                        myUploadsDiv.style.display = 'block';
                        let html = '<h2><i class="fas fa-list"></i> My Uploaded Questions</h2>';
                        html += '<div style="display: flex; flex-wrap: wrap; gap: 1rem;">';

                        myQuestions.forEach(question => {
                            html += `
                                    <div class="upload-actions">
                                        <button class="edit-btn" onclick="editQuestion('${question._id}')" style="background: #3498db; color: white; border: none; border-radius: 5px; cursor: pointer; padding: 5px 10px; margin-right: 5px;">
                                            <i class="fas fa-edit"></i> Edit
                                        </button>
                                        <button class="delete-upload" onclick="deleteQuestion('${question._id}')" style="position: static; border-radius: 5px; padding: 5px 10px; width: auto; height: auto;">
                                            <i class="fas fa-trash"></i> Delete
                                        </button>
                                    </div>
                                    <h4>${question.title || 'Untitled Question'}</h4>
                                    <p>${question.subject} - ${question.grade}</p>
                                    <div class="question-content">${question.question.substring(0, 100)}...</div>
                                    ${question.has_file ? '<div class="has-file"><i class="fas fa-paperclip"></i> Has attached file</div>' : ''}
                                    <small>Difficulty: <span class="difficulty ${question.difficulty}">${question.difficulty}</span></small>
                                    <br>
                                    <small>Uploaded: ${new Date(question.created_at).toLocaleDateString()}</small>
                                </div>
                            `;
                        });

                        html += '</div>';
                        myUploadsDiv.innerHTML = html;
                    } else {
                        myUploadsDiv.style.display = 'none';
                    }
                }
            } catch (error) {
                console.error("Error loading my uploads:", error);
            }
        }

        async function deleteQuestion(questionId) {
            if (!await showConfirmModal('Delete Question', 'Are you sure you want to delete this question?', 'delete')) return;

            try {
                const response = await fetch(window.BACKEND_URL + `/tutor/questions/${questionId}`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: window.currentUsername })
                });

                const result = await response.json();

                if (result.success) {
                    showNotification("Question deleted successfully!", "success");
                    loadQuestions();
                    loadMyQuestionUploads();
                } else {
                    showNotification("Error: " + result.message, "error");
                }
            } catch (error) {
                console.error("Delete error:", error);
                showNotification("Failed to delete question", "error");
            }
        }

        async function downloadQuestionFile(questionId) {
            if (!window.currentUsername) {
                showLogin('student');
                return;
            }

            try {
                const response = await fetch(window.BACKEND_URL + `/questions/download/${questionId}`);
                const result = await response.json();

                if (result.success) {
                    if (result.file_data) {
                        // Download binary file
                        const binaryString = window.atob(result.file_data);
                        const bytes = new Uint8Array(binaryString.length);
                        for (let i = 0; i < binaryString.length; i++) {
                            bytes[i] = binaryString.charCodeAt(i);
                        }
                        const blob = new Blob([bytes], { type: result.file_type });
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = result.file_name;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        window.URL.revokeObjectURL(url);
                    } else if (result.text_content) {
                        // Download text content
                        const element = document.createElement('a');
                        const file = new Blob([result.text_content], { type: 'text/plain' });
                        element.href = URL.createObjectURL(file);
                        element.download = result.file_name;
                        document.body.appendChild(element);
                        element.click();
                        document.body.removeChild(element);
                    }
                } else {
                    showNotification("Error: " + result.message, "error");
                }
            } catch (error) {
                console.error("Download error:", error);
                showNotification("Failed to download file", "error");
            }
        }

        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', function () {
            // Set up form submission
            const form = document.getElementById('questionUploadForm');
            if (form) {
                form.addEventListener('submit', uploadQuestion);
            }

            // Check if tutor is logged in and approved
            if (window.currentUsername && window.userType === 'tutor' && window.tutorApprovalStatus === 'approved') {
                document.getElementById('tutorQuestionUploadBtn').style.display = 'block';
                loadMyQuestionUploads();
            }

            // Load initial questions
            loadQuestions();
        });

        // Make functions globally available
        window.toggleQuestionUploadForm = toggleQuestionUploadForm;
        window.uploadQuestion = uploadQuestion;
        window.deleteQuestion = deleteQuestion;
        window.downloadQuestionFile = downloadQuestionFile;
        window.loadMyQuestionUploads = loadMyQuestionUploads;
    </script>
    <script src="common.js"></script>
    <script src="questiontag.js"></script>
</body>

</html>